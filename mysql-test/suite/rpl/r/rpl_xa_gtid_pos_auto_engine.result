include/master-slave.inc
[connection master]
connection slave;
call mtr.add_suppression("The automatically created table.*name may not be entirely in lowercase");
include/stop_slave.inc
CHANGE MASTER TO master_use_gtid=slave_pos;
SET @@global.gtid_pos_auto_engines="innodb";
include/start_slave.inc
connection master;
create table t1 (a int, b int) engine=InnoDB;
insert into t1 values(0, 0);
xa start 't';
insert into t1 values(1, 2);
xa end 't';
xa prepare 't';
xa commit 't';
connection slave;
include/diff_tables.inc [master:t1, slave:t1]
connection master;
xa start 't';
insert into t1 values(3, 4);
xa end 't';
xa prepare 't';
xa rollback 't';
connection slave;
include/diff_tables.inc [master:t1, slave:t1]
connection master;
SET pseudo_slave_mode=1;
create table t2 (a int) engine=InnoDB;
xa start 't';
insert into t1 values (5, 6);
xa end 't';
xa prepare 't';
xa start 's';
insert into t2 values (0);
xa end 's';
xa prepare 's';
include/save_master_gtid.inc
connection slave;
include/sync_with_master_gtid.inc
SELECT @@global.gtid_slave_pos = CONCAT(domain_id,"-",server_id,"-",seq_no) FROM mysql.gtid_slave_pos WHERE seq_no = (SELECT DISTINCT max(seq_no) FROM mysql.gtid_slave_pos);
@@global.gtid_slave_pos = CONCAT(domain_id,"-",server_id,"-",seq_no)
1
xa recover;
formatID	gtrid_length	bqual_length	data
1	1	0	t
1	1	0	s
connection master;
xa commit 't';
xa commit 's';
SET pseudo_slave_mode=0;
connection slave;
include/diff_tables.inc [master:t1, slave:t1]
include/diff_tables.inc [master:t2, slave:t2]
connection master;
drop table t1, t2;
connection slave;
include/stop_slave.inc
SET @@global.gtid_pos_auto_engines="";
SET @@session.sql_log_bin=0;
DROP TABLE mysql.gtid_slave_pos_InnoDB;
SET @@session.sql_log_bin=1;
include/start_slave.inc
include/rpl_end.inc
